openapi: 3.1.0
info:
  title: Auction App API (Đã thêm Security)
  version: 1.0.0
  description:
    RESTful API cho nền tảng đấu giá trực tuyến, được tạo lại từ các tệp routes.

servers:
  - url: http://localhost:3000/api
    description: Máy chủ phát triển local

tags:
  - name: Auth
    description: Xác thực người dùng (Đăng ký, Đăng nhập, Đăng xuất)
  - name: Users
    description: Quản lý thông tin người dùng
  - name: Seller
    description: Các hành động liên quan đến Người bán
  - name: Buyer
    description: Các hành động liên quan đến Người mua
  - name: Products
    description: Quản lý sản phẩm nói chung
  - name: Categories
    description: Quản lý danh mục sản phẩm
  - name: Auctions
    description: Quản lý các phiên đấu giá
  - name: DirectSales
    description: Quản lý các sản phẩm bán trực tiếp
  - name: Transactions
    description: Quản lý giao dịch và đơn hàng
  - name: Reviews
    description: Quản lý đánh giá sản phẩm/người dùng

paths:
  ##################################
  # Auth (từ AuthRoutes.js)
  ##################################
  /auth/sign-up:
    post:
      tags: [Auth]
      summary: Đăng ký người dùng mới (Public)
      requestBody:
        $ref: "#/components/requestBodies/UserRegister"
      responses:
        "201":
          description: Tạo người dùng thành công

  /auth/sign-in:
    post:
      tags: [Auth]
      summary: Đăng nhập và nhận token JWT (Public)
      requestBody:
        $ref: "#/components/requestBodies/UserLogin"
      responses:
        "200":
          description: Đăng nhập thành công

  /auth/log-out:
    post:
      tags: [Auth]
      summary: Đăng xuất người dùng (Cần token)
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Đăng xuất thành công

  ##################################
  # Users (từ UserRoutes.js)
  ##################################
  /users:
    get:
      tags: [Users]
      summary: Lấy danh sách tất cả người dùng (Cần token, Admin)
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Danh sách người dùng

  # LƯU Ý: Đặt route /profile TRƯỚC /:userId
  /users/profile:
    get:
      tags: [Users]
      summary: Lấy thông tin profile của chính mình (Cần token)
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Thông tin profile

  # /users/{userId}:
  #   get:
  #     tags: [Users]
  #     summary: Lấy thông tin chi tiết người dùng bằng ID (Cần token)
  #     security:
  #       - bearerAuth: []
  #     parameters:
  #       - $ref: "#/components/parameters/UserId"
  #     responses:
  #       "200":
  #         description: Chi tiết người dùng
  #   put:
  #     tags: [Users]
  #     summary: Cập nhật thông tin người dùng (Cần token)
  #     security:
  #       - bearerAuth: []
  #     parameters:
  #       - $ref: "#/components/parameters/UserId"
  #     requestBody:
  #       $ref: "#/components/requestBodies/UserUpdate"
  #     responses:
  #       "200":
  #         description: Cập nhật thành công
  #   delete:
  #     tags: [Users]
  #     summary: Xóa người dùng (Cần token, Admin)
  #     security:
  #       - bearerAuth: []
  #     parameters:
  #       - $ref: "#/components/parameters/UserId"
  #     responses:
  #       "204":
  #         description: Xóa thành công

  # /users/{id}/bids:
  #   get:
  #     tags: [Users]
  #     summary: Lấy tất cả các lượt đặt giá của một người dùng (Cần token)
  #     security:
  #       - bearerAuth: []
  #     parameters:
  #       - $ref: "#/components/parameters/GenericId"
  #     responses:
  #       "200":
  #         description: Danh sách các lượt đặt giá

  ##################################
  # Seller (từ SellerRoutes.js)
  ##################################
  /seller/products:
    get:
      tags: [Seller]
      summary: Lấy tất cả sản phẩm của một người bán (Cần token)
      security:
        - bearerAuth: []
      parameters:
        - $ref: "#/components/parameters/GenericId"
      responses:
        "200":
          description: Danh sách sản phẩm của người bán
    # post:
    #   tags: [Seller]
    #   summary: Người bán tạo một sản phẩm mới (Cần token)
    #   security:
    #     - bearerAuth: []
    #   parameters:
    #     - $ref: "#/components/parameters/GenericId"
    #   requestBody:
    #     $ref: "#/components/requestBodies/ProductCreate"
    #   responses:
    #     "201":
    #       description: Tạo sản phẩm thành công

  # /seller/{id}/reviews:
  #   get:
  #     tags: [Seller]
  #     summary: Lấy tất cả đánh giá về một người bán (Cần token)
  #     security:
  #       - bearerAuth: []
  #     parameters:
  #       - $ref: "#/components/parameters/GenericId"
  #     responses:
  #       "200":
  #         description: Danh sách đánh giá
  /seller/transactions:
    get:
      tags: [Seller]
      summary: Lấy tất cả giao dịch của người bán
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Danh sách các giao dịch

  ##################################
  # Buyer (từ BuyerRoutes.js)
  ##################################
  /buyer/{id}/transactions:
    get:
      tags: [Buyer]
      summary: Lấy tất cả giao dịch (đơn hàng) của một người mua (Cần token)
      security:
        - bearerAuth: []
      parameters:
        - $ref: "#/components/parameters/GenericId"
      responses:
        "200":
          description: Danh sách giao dịch
  /buyer/{id}/bids:
    get:
      tags: [Buyer]
      summary: Lấy tất cả các lượt đặt giá của một người mua (Cần token)
      security:
        - bearerAuth: []
      parameters:
        - $ref: "#/components/parameters/GenericId"
      responses:
        "200":
          description: Danh sách lượt đặt giá
  /buyer/{id}/reviews:
    get:
      tags: [Buyer]
      summary: Lấy tất cả các đánh giá do một người mua viết (Cần token)
      security:
        - bearerAuth: []
      parameters:
        - $ref: "#/components/parameters/GenericId"
      responses:
        "200":
          description: Danh sách đánh giá

  ##################################
  # Products (từ ProductRoutes.js)
  ##################################
  /products:
    get:
      tags: [Products]
      summary:
        Lấy danh sách sản phẩm (Public, có thể lọc), hoặc chi tiết một sản phẩm
      parameters: # Thêm tham số lọc (từ các câu trước)
        - name: productId
          in: query
          schema:
            type: string
        - name: limit
          in: query
          schema: { type: integer, default: 10 }
        - name: offset
          in: query
          schema: { type: integer, default: 0 }
        - name: name
          in: query
          schema: { type: string }
        - name: categoryId
          in: query
          schema: { type: integer }
        - name: minPrice
          in: query
          schema: { type: number }
        - name: maxPrice
          in: query
          schema: { type: number }
      responses:
        "200":
          description: Danh sách sản phẩm Hoặc chi tiết một sản phẩm (theo ID)
    post:
      tags: [Products]
      summary: Tạo một sản phẩm mới (Cần token, Seller)
      security:
        - bearerAuth: []
      requestBody:
        $ref: "#/components/requestBodies/ProductCreate"
      responses:
        "201":
          description: Tạo sản phẩm thành công

    # /products/{id}:
    # get:
    #   tags: [Products]
    #   summary: Lấy chi tiết một sản phẩm (Public)
    #   parameters:
    #     - $ref: "#/components/parameters/GenericId"
    #   responses:
    #     "200":
    #       description: Chi tiết sản phẩm
    patch:
      tags: [Products]
      summary: Cập nhật một phần thông tin sản phẩm (Cần token, Seller)
      security:
        - bearerAuth: []
      parameters:
        - name: productId
          in: query
          required: true
          schema:
            type: string
      requestBody:
        $ref: "#/components/requestBodies/ProductUpdate"
      responses:
        "200":
          description: Cập nhật thành công
    delete:
      tags: [Products]
      summary: Xóa một sản phẩm (Cần token, Seller)
      security:
        - bearerAuth: []
      parameters:
        - name: productId
          in: query
          required: true
          schema:
            type: string
      responses:
        "204":
          description: Xóa thành công

  ##################################
  # Categories (từ CategoryRoutes.js)
  ##################################
  /categories:
    get:
      tags: [Categories]
      summary: Lấy tất cả danh mục (Public)
      parameters:
        - name: name
          in: query
          required: false
          schema:
            type: string
      responses:
        "200":
          description: Danh sách danh mục
    # post:
    #   tags: [Categories]
    #   summary: Tạo một danh mục mới (Cần token, Admin)
    #   security:
    #     - bearerAuth: []
    #   requestBody:
    #     $ref: "#/components/requestBodies/CategoryCreate"
    #   responses:
    #     "201":
    #       description: Tạo danh mục thành công

  # /categories/{id}:
  #   get:
  #     tags: [Categories]
  #     summary: Lấy chi tiết một danh mục (Public)
  #     parameters:
  #       - $ref: "#/components/parameters/GenericId"
  #     responses:
  #       "200":
  #         description: Chi tiết danh mục
  #   put:
  #     tags: [Categories]
  #     summary: Cập nhật một danh mục (Cần token, Admin)
  #     security:
  #       - bearerAuth: []
  #     parameters:
  #       - $ref: "#/components/parameters/GenericId"
  #     requestBody:
  #       $ref: "#/components/requestBodies/CategoryCreate"
  #     responses:
  #       "200":
  #         description: Cập nhật thành công
  #   delete:
  #     tags: [Categories]
  #     summary: Xóa một danh mục (Cần token, Admin)
  #     security:
  #       - bearerAuth: []
  #     parameters:
  #       - $ref: "#/components/parameters/GenericId"
  #     responses:
  #       "204":
  #         description: Xóa thành công

  ##################################
  # Auctions (từ AuctionRoutes.js)
  ##################################
  /auctions:
    get:
      tags: [Auctions]
      summary: Lấy tất cả hoặc một phiên đấu giá đang hoạt động (Public)
      parameters:
        - name: auctionId
          in: query
          required: false
          schema:
            type: string
      responses:
        "200":
          description: Danh sách các phiên đấu giá
    post:
      tags: [Auctions]
      summary: Tạo một phiên đấu giá mới (Cần token, Seller)
      security:
        - bearerAuth: []
      parameters:
        - name: productId
          in: query
          required: true
          schema:
            type: string
      requestBody:
        $ref: "#/components/requestBodies/AuctionCreate"
      responses:
        "201":
          description: Tạo đấu giá thành công
    put:
      tags: [Auctions]
      summary: Cập nhật thông tin phiên đấu giá (Cần token, Seller)
      security:
        - bearerAuth: []
      parameters:
        - name: auctionId
          in: query
          required: true
          schema:
            type: string
      requestBody:
        $ref: "#/components/requestBodies/AuctionCreate"
      responses:
        "200":
          description: Cập nhật thành công
    delete:
      tags: [Auctions]
      summary: Hủy một phiên đấu giá (Cần token, Seller)
      security:
        - bearerAuth: []
      parameters:
        - name: auctionId
          in: query
          required: true
          schema:
            type: string
      responses:
        "204":
          description: Xóa thành công

  /auctions/join:
    post:
      tags: [Auctions]
      summary: Người dùng tham gia (theo dõi) phiên đấu giá (Cần token, Buyer)
      security:
        - bearerAuth: []
      parameters:
        - name: auctionId
          in: query
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Tham gia thành công

  /auctions/bids:
    get:
      tags: [Auctions]
      summary: Lấy tất cả các lượt đặt giá của một phiên đấu giá (Public)
      parameters:
        - name: auctionId
          in: query
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Danh sách các lượt đặt giá
    post:
      tags: [Auctions]
      summary: Người dùng đặt giá cho một phiên đấu giá (Cần token, Buyer)
      security:
        - bearerAuth: []
      parameters:
        - name: auctionId
          in: query
          required: true
          schema:
            type: string
      requestBody:
        $ref: "#/components/requestBodies/BidCreate"
      responses:
        "201":
          description: Đặt giá thành công

  ##################################
  # DirectSales (từ DirectSalesRoutes.js)
  ##################################
  # /direct-sales:
  #   get:
  #     tags: [DirectSales]
  #     summary: Lấy tất cả sản phẩm bán trực tiếp (Public)
  #     responses:
  #       "200":
  #         description: Danh sách sản phẩm
  #   post:
  #     tags: [DirectSales]
  #     summary: Tạo một sản phẩm bán trực tiếp mới (Cần token)
  #     security:
  #       - bearerAuth: []
  #     requestBody:
  #       $ref: "#/components/requestBodies/DirectSaleCreate"
  #     responses:
  #       "201":
  #         description: Tạo thành công

  # /direct-sales/{id}:
  #   get:
  #     tags: [DirectSales]
  #     summary: Lấy chi tiết sản phẩm bán trực tiếp (Public)
  #     parameters:
  #       - $ref: "#/components/parameters/GenericId"
  #     responses:
  #       "200":
  #         description: Chi tiết sản phẩm
  #   put:
  #     tags: [DirectSales]
  #     summary: Cập nhật sản phẩm bán trực tiếp (Cần token)
  #     security:
  #       - bearerAuth: []
  #     parameters:
  #       - $ref: "#/components/parameters/GenericId"
  #     requestBody:
  #       $ref: "#/components/requestBodies/DirectSaleCreate"
  #     responses:
  #       "200":
  #         description: Cập nhật thành công
  #   delete:
  #     tags: [DirectSales]
  #     summary: Xóa sản phẩm bán trực tiếp (Cần token)
  #     security:
  #       - bearerAuth: []
  #     parameters:
  #       - $ref: "#/components/parameters/GenericId"
  #     responses:
  #       "204":
  #         description: Xóa thành công

  /direct-sales/buy:
    post:
      tags: [DirectSales]
      summary: Người dùng mua ngay một sản phẩm (Cần token, Buyer)
      security:
        - bearerAuth: []
      parameters:
        - name: directSaleId
          in: query
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Mua thành công, tạo giao dịch

  ##################################
  # Transactions (từ TransactionRoutes.js)
  ##################################
  /transactions:
    # get:
    #   tags: [Transactions]
    #   summary: Lấy tất cả giao dịch (Cần token, Admin)
    #   security:
    #     - bearerAuth: []
    #   responses:
    #     "200":
    #       description: Danh sách giao dịch

    # /transactions/{id}:
    # get:
    #   tags: [Transactions]
    #   summary: Lấy chi tiết một giao dịch (đơn hàng) (Cần token)
    #   security:
    #     - bearerAuth: []
    #   parameters:
    #     - $ref: "#/components/parameters/GenericId"
    #   responses:
    #     "200":
    #       description: Chi tiết giao dịch
    # post:
    #   tags: [Transactions]
    #   summary: Tạo một giao dịch mới (Cần token)
    #   security:
    #     - bearerAuth: []
    #   parameters:
    #     - $ref: "#/components/parameters/GenericId"
    #   responses:
    #     "201":
    #       description: Tạo giao dịch thành công
    put:
      tags: [Transactions]
      summary: Cập nhật trạng thái giao dịch (Cần token, Seller)
      security:
        - bearerAuth: []
      parameters:
        - name: transactionId
          in: query
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Cập nhật thành công
    delete:
      tags: [Transactions]
      summary: Hủy một giao dịch (Cần token, Seller)
      security:
        - bearerAuth: []
      parameters:
        - name: transactionId
          in: query
          required: true
          schema:
            type: string
      responses:
        "204": # Sửa lỗi "2Scrollback" từ file gốc
          description: Hủy thành công

  ##################################
  # Reviews (từ ReviewRoutes.js)
  ##################################
  /reviews:
    get:
      tags: [Reviews]
      summary: Lấy tất cả các đánh giá (Public) của một Transaction
      parameters:
        - name: transactionId
          in: query
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Danh sách đánh giá

    # /reviews/{id}:
    #   get:
    #     tags: [Reviews]
    #     summary: Lấy chi tiết một đánh giá (Public)
    #     responses:
    #       "200":
    #         description: Chi tiết đánh giá
    post:
      tags: [Reviews]
      summary: Tạo một đánh giá mới (cho một giao dịch) (Cần token, Buyer)
      security:
        - bearerAuth: []
      parameters:
        - name: transactionId
          in: query
          required: true
          schema:
            type: string
      requestBody:
        $ref: "#/components/requestBodies/ReviewCreate"
      responses:
        "201":
          description: Tạo đánh giá thành công
    put:
      tags: [Reviews]
      summary: Chỉnh sửa một đánh giá (Cần token, Buyer)
      security:
        - bearerAuth: []
      parameters:
        - name: reviewId
          in: query
          required: true
          schema:
            type: string
      requestBody:
        $ref: "#/components/requestBodies/ReviewCreate"
      responses:
        "200":
          description: Cập nhật thành công
    delete:
      tags: [Reviews]
      summary: Xóa một đánh giá (Cần token, Buyer)
      security:
        - bearerAuth: []
      parameters:
        - name: reviewId
          in: query
          required: true
          schema:
            type: string
      responses:
        "204":
          description: Xóa thành công

##################################
# Components (Định nghĩa chung)
##################################
components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  parameters:
    GenericId:
      name: id
      in: path
      required: true
      description: ID của đối tượng
      schema:
        type: string
    UserId:
      name: userId
      in: path
      required: true
      description: ID của người dùng
      schema:
        type: string

  requestBodies:
    UserRegister:
      description: Thông tin đăng ký người dùng mới
      required: true
      content:
        application/json:
          schema:
            type: object
            properties:
              email:
                type: string
                example: "user@example.com"
              password:
                type: string
                example: "password123"
              username:
                type: string
                example: "newuser"
              name:
                type: string
                example: "John Doe"
              roles: # Thêm roles cho Lựa chọn 2
                type: array
                items:
                  type: string
                  enum: [BUYER, SELLER]
                example: ["BUYER", "SELLER"]
    UserLogin:
      description: Thông tin đăng nhập
      required: true
      content:
        application/json:
          schema:
            type: object
            properties:
              email:
                type: string
                example: "user@example.com"
              password:
                type: string
                example: "password123"
    UserUpdate:
      description: Thông tin cập nhật người dùng
      required: true
      content:
        application/json:
          schema:
            type: object
            properties:
              name: # Sửa từ full_name (file gốc) sang name
                type: string
              address:
                type: string
              phone_number:
                type: string
    ProductCreate:
      description: Thông tin tạo sản phẩm mới
      required: true
      content:
        application/json:
          schema:
            type: object
            properties:
              name:
                type: string
                example: "Laptop cũ"
              description:
                type: string
              category_id:
                type: integer
    ProductUpdate:
      description: Thông tin cập nhật sản phẩm
      required: true
      content:
        application/json:
          schema:
            type: object
            properties:
              name:
                type: string
              description:
                type: string
              status:
                type: string
    CategoryCreate:
      description: Thông tin tạo danh mục mới
      required: true
      content:
        application/json:
          schema:
            type: object
            properties:
              name:
                type: string
                example: "Đồ điện tử"
              parent_category_id:
                type: integer
    AuctionCreate:
      description: Thông tin tạo phiên đấu giá
      required: true
      content:
        application/json:
          schema:
            type: object
            properties:
              product_id:
                type: integer
              start_price:
                type: number
              auction_start_time:
                type: string
                format: date-time
              auction_end_time:
                type: string
                format: date-time
    BidCreate:
      description: Thông tin đặt giá
      required: true
      content:
        application/json:
          schema:
            type: object
            properties:
              bid_amount:
                type: number
    DirectSaleCreate:
      description: Thông tin tạo sản phẩm bán ngay
      required: true
      content:
        application/json:
          schema:
            type: object
            properties:
              product_id:
                type: integer
              buy_now_price:
                type: number
    ReviewCreate:
      description: Thông tin tạo đánh giá
      required: true
      content:
        application/json:
          schema:
            type: object
            properties:
              rating:
                type: integer
                format: int32
                minimum: 1
                maximum: 5
              comment:
                type: string
              transaction_id:
                type: integer
